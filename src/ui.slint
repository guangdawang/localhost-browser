// ========== UIå®šä¹‰æ–‡ä»¶ ==========

// å¯¼å…¥æ ‡å‡†ç»„ä»¶åº“
import { GroupBox, CheckBox, SpinBox, LineEdit, Button, ProgressIndicator } from "std-widgets.slint";

// ä¸»é¢˜åˆ‡æ¢ç»„ä»¶
component ThemeToggle {
    in property <string> current-theme: "system";
    callback theme-changed(string);
    
    HorizontalLayout {
        spacing: 10px;
        
        Button {
            text: "æµ…è‰²";
            enabled: current-theme != "light";
            clicked => { theme-changed("light"); }
        }
        
        Button {
            text: "æ·±è‰²";
            enabled: current-theme != "dark";
            clicked => { theme-changed("dark"); }
        }
        
        Button {
            text: "ç³»ç»Ÿ";
            enabled: current-theme != "system";
            clicked => { theme-changed("system"); }
        }
    }
}

// ä¸»çª—å£ç»„ä»¶
export component MainWindow inherits Window {
    // ========== å±æ€§ ==========
    in property <string> window-title;
    in property <int> window-width;
    in property <int> window-height;
    
    in-out property <bool> use-default-port: true;
    in property <int> default-port: 8080;
    in-out property <bool> auto-launch: false;
    in-out property <bool> auto-close: false;
    
    in property <[string]> recent-ports;
    in property <[string]> quick-ports;
    
    // çŠ¶æ€å±æ€§
    in-out property <string> port-input: "8080";
    in property <bool> is-port-valid: true;
    in property <string> port-validation-message: "";
    in-out property <string> status-message: "å°±ç»ª";
    in-out property <bool> is-launching: false;
    in-out property <string> current-theme: "system";
    
    // ========== å›è°ƒ ==========
    callback validate-port-input(string);
    callback launch-browser(string, bool, bool);
    callback quick-port-selected(string);
    callback save-config();
    callback window-resized(int, int);
    
    // ========== UIå¸ƒå±€ ==========
    VerticalLayout {
        spacing: 12px;
        padding: 20px;
        
        // æ ‡é¢˜
        Text {
            text: "ğŸš€ é«˜æ€§èƒ½ç«¯å£æµè§ˆå™¨";
            font-size: 24px;
            font-weight: 700;
            horizontal-alignment: center;
            color: #2563eb;
        }
        
        // ç«¯å£é…ç½®åŒºåŸŸ
        GroupBox {
            title: "ç«¯å£é…ç½®";
            
            VerticalLayout {
                spacing: 10px;
                
                // é»˜è®¤ç«¯å£é€‰é¡¹
                HorizontalLayout {
                    alignment: start;
                    spacing: 10px;
                    
                    CheckBox {
                        text: "ä½¿ç”¨é»˜è®¤ç«¯å£ (localhost)";
                        checked: root.use-default-port;
                        toggled => {
                            root.use-default-port = self.checked;
                        }
                    }
                    
                    SpinBox {
                        visible: !root.use-default-port;
                        minimum: 1;
                        maximum: 65535;
                        value: root.default-port;
                        width: 100px;
                    }
                }
                
                // è‡ªå®šä¹‰ç«¯å£è¾“å…¥
                GroupBox {
                    title: "è‡ªå®šä¹‰ç«¯å£";
                    visible: !root.use-default-port;
                    
                    VerticalLayout {
                        spacing: 8px;
                        
                        HorizontalLayout {
                            Text {
                                text: "ç«¯å£å·:";
                                width: 80px;
                            }
                            
                            LineEdit {
                                text: root.port-input;
                                placeholder-text: "è¾“å…¥ 1-65535";
                                width: 150px;
                                
                                edited => {
                                    root.port-input = self.text;
                                    root.validate-port-input(self.text);
                                }
                            }
                        }
                        
                        // éªŒè¯ä¿¡æ¯
                        Text {
                            text: root.port-validation-message;
                            color: root.is-port-valid ? #10b981 : #ef4444;
                            font-size: 12px;
                        }
                    }
                }
            }
        }
        
        // å¿«æ·ç«¯å£
        GroupBox {
            title: "å¿«æ·ç«¯å£";
            visible: root.quick-ports.length > 0;
            
            HorizontalLayout {
                spacing: 8px;
                
                for port in root.quick-ports : Button {
                    text: port;
                    width: 60px;
                    clicked => {
                        root.quick-port-selected(port);
                    }
                }
            }
        }
        
        // æœ€è¿‘ä½¿ç”¨
        GroupBox {
            title: "æœ€è¿‘ä½¿ç”¨";
            visible: root.recent-ports.length > 0;
            
            VerticalLayout {
                for data in root.recent-ports : HorizontalLayout {
                    spacing: 10px;
                    height: 30px;
                    
                    Text {
                        text: "â— " + data;
                        vertical-alignment: center;
                    }
                    
                    Button {
                        text: "æ‰“å¼€";
                        width: 50px;
                        clicked => {
                            root.quick-port-selected(data);
                        }
                    }
                }
            }
        }
        
        // é€‰é¡¹
        GroupBox {
            title: "é€‰é¡¹";
            
            VerticalLayout {
                spacing: 8px;
                
                CheckBox {
                    text: "è‡ªåŠ¨å¯åŠ¨æµè§ˆå™¨";
                    checked: root.auto-launch;
                }
                
                CheckBox {
                    text: "å¯åŠ¨åè‡ªåŠ¨å…³é—­çª—å£";
                    checked: root.auto-close;
                }

                ThemeToggle {
                    current-theme: root.current-theme;
                    theme-changed(theme) => {
                        root.current-theme = theme;
                        root.status-message = "ä¸»é¢˜å·²åˆ‡æ¢: " + theme;
                    }
                }
            }
        }
        
        // çŠ¶æ€åŒºåŸŸ
        GroupBox {
            title: "çŠ¶æ€";
            
            VerticalLayout {
                Text {
                    text: root.status-message;
                    wrap: word-wrap;
                }
                
                ProgressIndicator {
                    visible: root.is-launching;
                    indeterminate: true;
                }
            }
        }
        
        // æ“ä½œæŒ‰é’®
        HorizontalLayout {
            alignment: center;
            spacing: 20px;
            
            Button {
                text: "ğŸš€ å¯åŠ¨æµè§ˆå™¨";
                enabled: root.use-default-port || root.is-port-valid;
                width: 150px;
                
                clicked => {
                    root.is-launching = true;
                    root.launch-browser(root.port-input, root.use-default-port, root.auto-close);
                }
            }
            
            Button {
                text: "ğŸ’¾ ä¿å­˜é…ç½®";
                width: 100px;
                clicked => {
                    root.save-config();
                    root.status-message = "é…ç½®å·²ä¿å­˜";
                }
            }
        }
    }
    
    // ========== çª—å£å±æ€§ ==========
    width: root.window-width * 1px;
    height: root.window-height * 1px;
    title: root.window-title;
}

